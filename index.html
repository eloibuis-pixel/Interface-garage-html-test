<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GarageAI â€” Tableau de bord</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=Syne:wght@700;800&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%;overflow:hidden}
body{font-family:'DM Sans',sans-serif;background:#f1f5f9;color:#1e293b}
::-webkit-scrollbar{width:5px}::-webkit-scrollbar-thumb{background:#cbd5e1;border-radius:99px}
@keyframes pg{0%,100%{box-shadow:0 0 0 0 rgba(34,197,94,.5)}50%{box-shadow:0 0 0 6px rgba(34,197,94,0)}}
@keyframes fu{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
.pdot{width:8px;height:8px;background:#22c55e;border-radius:50%;animation:pg 2s infinite;flex-shrink:0}
.pdot-lg{width:10px;height:10px;background:#22c55e;border-radius:50%;animation:pg 2s infinite;flex-shrink:0}
.fup{animation:fu .3s ease both}
.layout{display:flex;height:100vh}

/* SIDEBAR */
.sidebar{width:220px;background:#0f172a;display:flex;flex-direction:column;padding:24px 16px;flex-shrink:0}
.logo-title{font-family:'Syne',sans-serif;font-weight:800;font-size:20px;color:white}
.logo-dot{color:#3b82f6}.logo-ai{color:#60a5fa}
.logo-sub{color:#475569;font-size:11px;margin-top:2px}
.nav-btn{display:flex;align-items:center;gap:10px;width:100%;padding:10px 12px;border-radius:12px;border:none;background:transparent;color:#94a3b8;font-weight:400;font-size:14px;margin-bottom:4px;text-align:left;transition:all .2s;cursor:pointer;font-family:'DM Sans',sans-serif}
.nav-btn.active{background:#1e40af;color:white;font-weight:600}
.ai-status{margin-top:14px;display:flex;align-items:center;gap:8px;padding:10px 12px;background:#1e293b;border-radius:12px}

/* MAIN */
.main{flex:1;overflow:auto;padding:24px;display:flex;flex-direction:column}
.header{display:flex;align-items:center;justify-content:space-between;margin-bottom:24px}
.page-title{font-family:'Syne',sans-serif;font-weight:800;font-size:26px;color:#0f172a;letter-spacing:-.5px}
.page-sub{color:#64748b;font-size:14px;margin-top:2px}
.new-btn{background:#3b82f6;color:white;border:none;border-radius:12px;padding:10px 18px;font-weight:600;font-size:14px;box-shadow:0 4px 14px rgba(59,130,246,.35);cursor:pointer;font-family:'DM Sans',sans-serif}

/* CARDS */
.card{background:white;border-radius:24px;padding:24px;box-shadow:0 2px 16px rgba(0,0,0,.06)}
.card-sm{background:white;border-radius:20px;padding:20px;box-shadow:0 2px 12px rgba(0,0,0,.06)}

/* GRIDS */
.dash-grid{display:grid;grid-template-columns:1fr 300px;gap:20px}
.left-col{display:flex;flex-direction:column;gap:20px}
.right-col{display:flex;flex-direction:column;gap:16px}
.stats-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:14px;margin-bottom:20px}
.clients-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:16px}

/* TABLE */
table{border-collapse:collapse;width:100%}
th{text-align:left;padding:8px 10px;font-size:12px;font-weight:600;color:#94a3b8;white-space:nowrap;border-bottom:2px solid #f1f5f9}
td{padding:11px 10px;border-bottom:1px solid #f8fafc;font-size:13px;vertical-align:middle;transition:background .15s}
tr:hover td{background:#f8fafc}
.prob-input{border:1px solid #e2e8f0;border-radius:8px;padding:5px 8px;font-size:12px;color:#334155;width:100%;background:#fafafa;font-family:'DM Sans',sans-serif;transition:border .15s,background .15s}
.prob-input:focus{outline:none;border-color:#3b82f6;background:white}
.badge{display:inline-block;background:#f1f5f9;border-radius:6px;padding:3px 8px;font-size:12px;color:#475569}

/* CALENDAR */
.cal-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
.cal-nav{background:#f1f5f9;border:none;border-radius:8px;width:28px;height:28px;color:#475569;font-size:18px;cursor:pointer;line-height:1}
.cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:2px}
.cal-day-name{text-align:center;font-size:11px;font-weight:600;color:#94a3b8;padding:3px 0}
.cal-day{text-align:center;padding:6px 2px;border-radius:8px;cursor:pointer;font-size:13px;border:1.5px solid transparent;transition:all .15s}
.cal-day:hover{background:#f1f5f9}
.cal-day.today{background:#3b82f6;color:white;font-weight:700}
.cal-day.selected{background:#eff6ff;border-color:#3b82f6}
.cal-day.empty{cursor:default;pointer-events:none}
.cal-dot{width:4px;height:4px;border-radius:50%;background:#3b82f6;margin:1px auto 0}
.cal-day.today .cal-dot{background:white}
.cal-hint{margin-top:10px;padding:8px 10px;background:#f8fafc;border-radius:10px;font-size:12px;color:#64748b;text-align:center}

/* CHART */
.chart-wrap{position:relative;width:100%}
svg.chart{width:100%;height:auto;overflow:visible}
.ctip{position:fixed;background:#0f172a;color:white;padding:5px 10px;border-radius:8px;font-size:12px;pointer-events:none;white-space:nowrap;z-index:9999;display:none}

/* OVERLAYS */
.overlay{position:fixed;inset:0;background:rgba(15,23,42,.65);z-index:200;display:none;align-items:center;justify-content:center;backdrop-filter:blur(4px)}
.overlay.open{display:flex}
.modal{background:white;border-radius:20px;width:520px;max-height:88vh;overflow:hidden;box-shadow:0 25px 60px rgba(0,0,0,.35);animation:fu .3s ease;display:flex;flex-direction:column}
.modal-hdr{background:#1e293b;padding:16px 20px;display:flex;align-items:center;justify-content:space-between;flex-shrink:0}
.modal-close{background:#334155;border:none;color:white;border-radius:8px;width:30px;height:30px;font-size:20px;cursor:pointer;line-height:1;display:flex;align-items:center;justify-content:center}
.modal-body{overflow-y:auto;padding:20px}

/* CALL DETAIL MODAL */
.detail-section{border-radius:12px;padding:12px 14px;margin-bottom:12px}
.detail-yellow{background:#fef3c7;border-left:4px solid #f59e0b}
.detail-blue{background:#eff6ff;border-left:4px solid #3b82f6}
.detail-gray{background:#f8fafc}
.detail-green{background:#f0fdf4;border-left:4px solid #22c55e}
.detail-label{font-weight:600;font-size:11px;color:#64748b;text-transform:uppercase;letter-spacing:.5px;margin-bottom:4px}
.detail-val{font-size:14px;color:#1e293b;font-weight:500}
.detail-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:12px}

/* AGENDA */
.agenda-row{display:flex;min-height:50px;border-bottom:1px solid #f1f5f9}
.agenda-time{width:46px;padding-top:10px;color:#94a3b8;font-size:11px;flex-shrink:0}
.agenda-slot{flex:1;padding:4px 0 4px 8px}
.agenda-event{background:#eff6ff;border-left:4px solid #3b82f6;border-radius:10px;padding:8px 12px}

/* MISC */
.tab-content{display:none}.tab-content.active{display:block}
.sec-title{font-family:'Syne',sans-serif;font-weight:700;font-size:15px;color:#1e293b;margin-bottom:14px}
.sec-title-lg{font-family:'Syne',sans-serif;font-weight:700;font-size:16px;color:#1e293b;margin-bottom:16px}
.ai-row{display:flex;justify-content:space-between;font-size:13px;margin-bottom:6px}
.stats-cta{background:linear-gradient(135deg,#0f172a,#1e293b);color:white;border:none;border-radius:20px;padding:16px;cursor:pointer;text-align:left;box-shadow:0 4px 16px rgba(0,0,0,.15);width:100%;font-family:'DM Sans',sans-serif}
.chart-hdr{display:flex;align-items:center;justify-content:space-between;margin-bottom:20px}
.pill{background:#eff6ff;color:#3b82f6;font-size:12px;padding:4px 10px;border-radius:99px;font-weight:600}
.stat-card{background:white;border-radius:16px;padding:16px;box-shadow:0 2px 12px rgba(0,0,0,.06)}
.prob-bar-bg{background:#f1f5f9;border-radius:99px;height:6px;margin-top:4px;margin-bottom:10px}
.prob-bar{background:#3b82f6;border-radius:99px;height:6px}
.client-card{background:white;border-radius:20px;padding:20px;box-shadow:0 2px 12px rgba(0,0,0,.06);cursor:pointer;transition:box-shadow .15s}
.client-card:hover{box-shadow:0 6px 24px rgba(0,0,0,.1)}
.row-link{cursor:pointer}

/* STATUS BADGES */
.status-rdv{display:inline-block;background:#eff6ff;color:#1d4ed8;font-size:11px;padding:3px 8px;border-radius:99px;font-weight:600}
.status-info{display:inline-block;background:#f0fdf4;color:#166534;font-size:11px;padding:3px 8px;border-radius:99px;font-weight:600}
.status-urgent{display:inline-block;background:#fef2f2;color:#dc2626;font-size:11px;padding:3px 8px;border-radius:99px;font-weight:600}
</style>
</head>
<body>
<div class="layout">
  <aside class="sidebar">
    <div style="margin-bottom:32px">
      <div class="logo-title">Garage<span class="logo-dot">.</span><span class="logo-ai">AI</span></div>
      <div class="logo-sub">Gestionnaire Automobile</div>
    </div>
    <nav style="flex:1" id="nav"></nav>
    <div class="ai-status">
      <div class="pdot"></div>
      <div>
        <div style="color:white;font-size:12px;font-weight:600">IA en ligne</div>
        <div style="color:#475569;font-size:10px">n8n Â· actif</div>
      </div>
    </div>
  </aside>

  <main class="main">
    <div class="header">
      <div>
        <h1 class="page-title" id="page-title">Tableau de bord</h1>
        <p class="page-sub" id="page-sub"></p>
      </div>
      <button class="new-btn" id="new-btn">+ Nouvel Appel</button>
    </div>

    <!-- DASHBOARD -->
    <div id="tab-dashboard" class="tab-content active">
      <div class="dash-grid">
        <div class="left-col">
          <div class="card">
            <div class="chart-hdr">
              <div>
                <div class="sec-title-lg" style="margin-bottom:2px">ActivitÃ© des appels</div>
                <div style="color:#94a3b8;font-size:13px" id="chart-sub">7 derniers jours</div>
              </div>
              <span class="pill">ğŸ“ˆ Semaine en cours</span>
            </div>
            <div class="chart-wrap" id="chart-main"></div>
          </div>
          <div class="card" id="calls-main"></div>
        </div>
        <div class="right-col">
          <div class="card-sm" id="cal-widget"></div>
          <div class="card-sm">
            <div style="display:flex;align-items:center;gap:8px;margin-bottom:14px">
              <div class="pdot-lg"></div>
              <span class="sec-title" style="margin:0">IA en ligne</span>
            </div>
            <div class="ai-row"><span style="color:#94a3b8">ModÃ¨le</span><span style="font-weight:500">GPT-4o via n8n</span></div>
            <div class="ai-row"><span style="color:#94a3b8">Webhook</span><span style="font-weight:500">ConnectÃ© âœ“</span></div>
            <div class="ai-row"><span style="color:#94a3b8">RÃ©ponse moy.</span><span style="font-weight:500">1.4s</span></div>
            <div class="ai-row"><span style="color:#94a3b8">Appels traitÃ©s</span><span style="font-weight:500" id="ai-count">0 ce mois</span></div>
          </div>
          <button class="stats-cta" id="stats-cta">
            <div style="font-size:24px;margin-bottom:6px">ğŸ“Š</div>
            <div style="font-weight:700;font-family:'Syne',sans-serif;font-size:14px;margin-bottom:4px">Voir les statistiques</div>
            <div style="font-size:12px;color:#94a3b8">Conversion, top problÃ¨mes, tendances</div>
          </button>
        </div>
      </div>
    </div>

    <!-- CALLS -->
    <div id="tab-calls" class="tab-content">
      <div class="card fup" id="calls-tab"></div>
    </div>

    <!-- CLIENTS -->
    <div id="tab-clients" class="tab-content">
      <div class="clients-grid fup" id="clients-grid"></div>
    </div>

    <!-- STATS -->
    <div id="tab-stats" class="tab-content fup">
      <div class="stats-grid" id="stats-cards"></div>
      <div class="card-sm" style="margin-bottom:16px" id="probs-card"></div>
      <div class="card-sm" id="stats-chart-card"></div>
    </div>
  </main>
</div>

<!-- CALL DETAIL MODAL -->
<div class="overlay" id="detail-overlay">
  <div class="modal" id="detail-modal">
    <div class="modal-hdr">
      <div>
        <div style="color:#94a3b8;font-size:11px;text-transform:uppercase;letter-spacing:.5px">DÃ©tail de l'appel</div>
        <div id="detail-title" style="color:white;font-weight:700;font-size:16px;font-family:'Syne',sans-serif;margin-top:2px"></div>
      </div>
      <button class="modal-close" id="detail-close">Ã—</button>
    </div>
    <div class="modal-body" id="detail-body"></div>
  </div>
</div>

<!-- AGENDA MODAL -->
<div class="overlay" id="agenda-overlay">
  <div class="modal" id="agenda-modal" style="width:480px">
    <div class="modal-hdr">
      <div>
        <div style="color:#94a3b8;font-size:12px">Agenda du</div>
        <div id="agenda-title" style="color:white;font-weight:700;font-size:16px;font-family:'Syne',sans-serif"></div>
      </div>
      <button class="modal-close" id="agenda-close">Ã—</button>
    </div>
    <div class="modal-body" id="agenda-body" style="padding:8px 16px 20px"></div>
  </div>
</div>

<!-- NEW CALL MODAL -->
<div class="overlay" id="new-overlay">
  <div class="modal" style="width:480px">
    <div class="modal-hdr">
      <div>
        <div style="color:#94a3b8;font-size:11px;text-transform:uppercase;letter-spacing:.5px">Ajouter manuellement</div>
        <div style="color:white;font-weight:700;font-size:16px;font-family:'Syne',sans-serif;margin-top:2px">Nouvel appel</div>
      </div>
      <button class="modal-close" id="new-close">Ã—</button>
    </div>
    <div class="modal-body">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px">
        <div>
          <label style="font-size:12px;font-weight:600;color:#64748b;display:block;margin-bottom:4px">PrÃ©nom *</label>
          <input id="f-prenom" class="prob-input" style="width:100%;padding:8px 10px" placeholder="Jean">
        </div>
        <div>
          <label style="font-size:12px;font-weight:600;color:#64748b;display:block;margin-bottom:4px">NumÃ©ro *</label>
          <input id="f-numero" class="prob-input" style="width:100%;padding:8px 10px" placeholder="06 12 34 56 78">
        </div>
      </div>
      <div style="margin-bottom:12px">
        <label style="font-size:12px;font-weight:600;color:#64748b;display:block;margin-bottom:4px">RÃ©sumÃ© *</label>
        <input id="f-resume" class="prob-input" style="width:100%;padding:8px 10px" placeholder="Bruit moteur anormal">
      </div>
      <div style="margin-bottom:12px">
        <label style="font-size:12px;font-weight:600;color:#64748b;display:block;margin-bottom:4px">ProblÃ¨me dÃ©taillÃ©</label>
        <textarea id="f-probleme" class="prob-input" style="width:100%;padding:8px 10px;height:72px;resize:vertical" placeholder="Description complÃ¨te du problÃ¨me signalÃ©..."></textarea>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px">
        <div>
          <label style="font-size:12px;font-weight:600;color:#64748b;display:block;margin-bottom:4px">Heure RDV</label>
          <input id="f-rdv" class="prob-input" style="width:100%;padding:8px 10px" type="datetime-local">
        </div>
        <div>
          <label style="font-size:12px;font-weight:600;color:#64748b;display:block;margin-bottom:4px">Chat ID (n8n)</label>
          <input id="f-chatid" class="prob-input" style="width:100%;padding:8px 10px" placeholder="auto-gÃ©nÃ©rÃ©">
        </div>
      </div>
      <div id="new-err" style="color:#dc2626;font-size:12px;margin-bottom:8px;display:none"></div>
      <button id="new-save" style="width:100%;background:#3b82f6;color:white;border:none;border-radius:12px;padding:12px;font-weight:600;font-size:14px;cursor:pointer;font-family:'DM Sans',sans-serif">Enregistrer l'appel</button>
    </div>
  </div>
</div>

<div class="ctip" id="ctip"></div>

<script>
// â”€â”€â”€ DATA â€” modifiable par n8n via addCall() â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Structure d'un appel :
// { id, prenom, numero, resume, probleme, heure_rdv (ISO string|null), timestamp (ISO), chat_id }

var CALLS = [
  {
    id: 1,
    prenom: 'Transports Dupont',
    numero: '06 12 34 56 78',
    resume: 'Bruit moteur anormal',
    probleme: 'Claquement au dÃ©marrage Ã  froid, possible problÃ¨me de distribution. VÃ©hicule : Renault Master 2019, 87 400 km.',
    heure_rdv: '2025-02-18T09:30',
    timestamp: '2025-02-18T08:02:14',
    chat_id: 'n8n_conv_001'
  },
  {
    id: 2,
    prenom: 'BTP Marchand SARL',
    numero: '07 89 01 23 45',
    resume: 'Voyant moteur allumÃ©',
    probleme: 'TÃ©moin orange allumÃ© depuis 3 jours, perte de puissance ressentie lors des montÃ©es. Peugeot Partner 2020.',
    heure_rdv: '2025-02-18T11:00',
    timestamp: '2025-02-18T09:15:33',
    chat_id: 'n8n_conv_002'
  },
  {
    id: 3,
    prenom: 'Livraisons Express 31',
    numero: '06 55 44 33 22',
    resume: 'Pneu crevÃ© sur A64',
    probleme: 'Crevaison arriÃ¨re droit, pneu de secours posÃ©. Souhaite rendez-vous pour remplacement complet des 4 pneus.',
    heure_rdv: null,
    timestamp: '2025-02-17T14:44:09',
    chat_id: 'n8n_conv_003'
  },
  {
    id: 4,
    prenom: 'Cabinet Notarial LÃ©on',
    numero: '05 61 78 90 12',
    resume: 'Vidange + rÃ©vision',
    probleme: 'VÃ©hicule Ã  45 000 km, rÃ©vision complÃ¨te demandÃ©e avec remplacement des filtres et vÃ©rification des plaquettes.',
    heure_rdv: '2025-02-19T14:00',
    timestamp: '2025-02-17T11:22:55',
    chat_id: 'n8n_conv_004'
  },
  {
    id: 5,
    prenom: 'Agence ImmobiliÃ¨re Sud',
    numero: '06 33 22 11 00',
    resume: 'Freins qui crissent',
    probleme: 'Bruit mÃ©tallique au freinage depuis une semaine, plus prononcÃ© Ã  faible vitesse. Plaquettes Ã  vÃ©rifier.',
    heure_rdv: '2025-02-20T10:00',
    timestamp: '2025-02-17T16:08:41',
    chat_id: 'n8n_conv_005'
  },
  {
    id: 6,
    prenom: 'Menuiserie Fabre',
    numero: '06 77 66 55 44',
    resume: 'Climatisation en panne',
    probleme: 'Clim ne refroidit plus depuis la semaine derniÃ¨re. VÃ©hicule : CitroÃ«n Berlingo 2021. Recharge gaz probable.',
    heure_rdv: null,
    timestamp: '2025-02-16T10:30:18',
    chat_id: 'n8n_conv_006'
  }
];

var RDV = {
  '2025-02-18':[
    {t:'09:30',dur:60,cl:'Transports Dupont',det:'Bruit moteur â€“ Diagnostic'},
    {t:'11:00',dur:90,cl:'BTP Marchand SARL',det:'Voyant moteur â€“ ContrÃ´le OBD'},
    {t:'14:30',dur:45,cl:'Auto Ã‰cole Martin',det:'ContrÃ´le technique prÃ©ventif'},
    {t:'16:00',dur:30,cl:'SARL Constructions Nord',det:'Devis carrosserie'}
  ],
  '2025-02-19':[
    {t:'08:30',dur:120,cl:'Cabinet Notarial LÃ©on',det:'Vidange + rÃ©vision 45k km'},
    {t:'11:00',dur:60,cl:'Flotte Renault SAS',det:'Remplacement courroie'},
    {t:'15:00',dur:45,cl:'Pharmacie Centrale',det:'Diagnostic Ã©lectronique'}
  ],
  '2025-02-20':[
    {t:'10:00',dur:60,cl:'Agence ImmobiliÃ¨re Sud',det:'Freins â€“ Remplacement plaquettes'},
    {t:'13:30',dur:90,cl:'SociÃ©tÃ© GÃ©nie Civil 31',det:'BoÃ®te de vitesses â€“ Inspection'}
  ],
  '2025-02-21':[
    {t:'09:00',dur:45,cl:'Restaurant Le Quercy',det:'Batterie dÃ©chargÃ©e â€“ Remplacement'},
    {t:'14:00',dur:120,cl:'Taxi Occitanie',det:'RÃ©vision complÃ¨te + contrÃ´le'},
    {t:'16:30',dur:30,cl:'Boulangerie Moreau',det:'Pneus â€“ Permutation saisonniÃ¨re'}
  ],
  '2025-02-24':[
    {t:'10:30',dur:60,cl:'Studio Photo LumiÃ¨re',det:'Climatisation â€“ Recharge gaz'},
    {t:'15:00',dur:45,cl:'Mairie de Blagnac',det:'ContrÃ´le pÃ©riodique flotte'}
  ]
};

var MFR=['Janvier','FÃ©vrier','Mars','Avril','Mai','Juin','Juillet','AoÃ»t','Septembre','Octobre','Novembre','DÃ©cembre'];
var DFR=['Lun','Mar','Mer','Jeu','Ven','Sam','Dim'];
var NAV=[{id:'dashboard',lb:'Tableau de bord',ic:'âŠ'},{id:'calls',lb:'Appels',ic:'ğŸ“'},{id:'clients',lb:'Clients',ic:'ğŸ‘¥'},{id:'stats',lb:'Statistiques',ic:'ğŸ“Š'}];
var calY=2025,calM=1,calSel=null;
var nextId=100;

// â”€â”€â”€ PUBLIC API â€” appelÃ©e par n8n â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Usage depuis n8n (HTTP Request ou webhook) :
// window.addCall({ prenom, numero, resume, probleme, heure_rdv, timestamp, chat_id })
function addCall(data) {
  var call = {
    id: nextId++,
    prenom: data.prenom || '',
    numero: data.numero || '',
    resume: data.resume || '',
    probleme: data.probleme || '',
    heure_rdv: data.heure_rdv || null,
    timestamp: data.timestamp || new Date().toISOString(),
    chat_id: data.chat_id || ''
  };
  CALLS.unshift(call);
  if (call.heure_rdv) {
    var dk = call.heure_rdv.split('T')[0];
    var hr = parseInt(call.heure_rdv.split('T')[1]);
    var tm = call.heure_rdv.split('T')[1].slice(0,5);
    if (!RDV[dk]) RDV[dk] = [];
    RDV[dk].push({t:tm, dur:60, cl:call.prenom, det:call.resume});
  }
  refresh();
}

function removeCall(id) {
  CALLS = CALLS.filter(function(c){return c.id !== id;});
  refresh();
}

function refresh() {
  buildChart('chart-main', chartData());
  buildCallsTable('calls-main');
  buildCallsTable('calls-tab');
  buildCalendar();
  buildStats();
  buildClients();
  updateAiCount();
}

// â”€â”€â”€ UTILS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function esc(s){return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}
function fmtDT(dt){
  if(!dt)return 'â€”';
  var d=new Date(dt);
  return d.toLocaleDateString('fr-FR',{day:'2-digit',month:'2-digit',year:'2-digit'})+' '+d.toLocaleTimeString('fr-FR',{hour:'2-digit',minute:'2-digit'});
}
function fmtTS(ts){
  if(!ts)return '';
  var d=new Date(ts);
  return d.toLocaleDateString('fr-FR',{day:'2-digit',month:'2-digit'})+' Ã  '+d.toLocaleTimeString('fr-FR',{hour:'2-digit',minute:'2-digit'});
}
function fmtFull(dt){
  if(!dt)return null;
  var d=new Date(dt);
  return d.toLocaleDateString('fr-FR',{weekday:'long',day:'numeric',month:'long'})+' Ã  '+d.toLocaleTimeString('fr-FR',{hour:'2-digit',minute:'2-digit'});
}
function dkey(y,m,d){return y+'-'+String(m+1).padStart(2,'0')+'-'+String(d).padStart(2,'0');}

// â”€â”€â”€ CHART DATA from CALLS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function chartData() {
  var days = [];
  for (var i=6; i>=0; i--) {
    var d = new Date(2025,1,18); d.setDate(d.getDate()-i);
    var dk = d.toISOString().split('T')[0];
    var label = ['Dim','Lun','Mar','Mer','Jeu','Ven','Sam'][d.getDay()]+' '+d.getDate();
    var count = CALLS.filter(function(c){return c.timestamp && c.timestamp.split('T')[0]===dk;}).length;
    days.push({day:label, n:count});
  }
  return days;
}

// â”€â”€â”€ TAB â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setTab(id){
  document.querySelectorAll('.tab-content').forEach(function(el){el.classList.remove('active');});
  document.getElementById('tab-'+id).classList.add('active');
  document.querySelectorAll('.nav-btn').forEach(function(b){b.classList.toggle('active',b.dataset.id===id);});
  var labs={dashboard:'Tableau de bord',calls:'Appels',clients:'Clients',stats:'Statistiques'};
  document.getElementById('page-title').textContent=labs[id];
}

// â”€â”€â”€ NAV â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildNav(){
  var nav=document.getElementById('nav');
  NAV.forEach(function(item){
    var b=document.createElement('button');
    b.className='nav-btn'+(item.id==='dashboard'?' active':'');
    b.dataset.id=item.id;
    b.innerHTML='<span style="font-size:16px">'+item.ic+'</span>'+esc(item.lb);
    b.onclick=function(){setTab(item.id);};
    nav.appendChild(b);
  });
}

// â”€â”€â”€ CHART â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildChart(id,data){
  var el=document.getElementById(id);
  if(!el)return;
  var total=0;for(var i=0;i<data.length;i++)total+=data[i].n;
  var csub=document.getElementById('chart-sub');
  if(csub)csub.textContent='7 derniers jours Â· '+total+' appels';
  var W=500,H=150,PX=36,PY=18,maxV=0;
  for(var j=0;j<data.length;j++){if(data[j].n>maxV)maxV=data[j].n;}
  if(maxV===0)maxV=1;
  function px(i){return PX+(i/(data.length-1))*(W-PX*2);}
  function py(v){return PY+(1-v/maxV)*(H-PY*2);}
  var ld=data.map(function(d,i){return (i===0?'M':'L')+px(i).toFixed(1)+','+py(d.n).toFixed(1);}).join(' ');
  var ad=ld+' L'+px(data.length-1).toFixed(1)+','+(H-PY)+' L'+px(0).toFixed(1)+','+(H-PY)+' Z';
  var uid='g'+Math.random().toString(36).slice(2,7);
  var gl=[0,0.33,0.66,1].map(function(t){
    var y=PY+t*(H-PY*2);
    return '<line x1="'+PX+'" y1="'+y.toFixed(1)+'" x2="'+(W-PX)+'" y2="'+y.toFixed(1)+'" stroke="#e2e8f0" stroke-width="1" stroke-dasharray="4,3"/><text x="'+(PX-5)+'" y="'+(y+4).toFixed(1)+'" text-anchor="end" font-size="10" fill="#94a3b8">'+Math.round(maxV*(1-t))+'</text>';
  }).join('');
  var pts=data.map(function(d,i){
    return '<circle class="cpt" cx="'+px(i).toFixed(1)+'" cy="'+py(d.n).toFixed(1)+'" r="5" fill="#3b82f6" stroke="white" stroke-width="2" data-d="'+esc(d.day)+'" data-n="'+d.n+'" style="cursor:pointer"/>'+
           '<text x="'+px(i).toFixed(1)+'" y="'+(H-3)+'" text-anchor="middle" font-size="10" fill="#64748b">'+d.day.split(' ')[0]+'</text>';
  }).join('');
  el.innerHTML='<svg class="chart" viewBox="0 0 '+W+' '+H+'"><defs><linearGradient id="'+uid+'" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="#3b82f6" stop-opacity="0.2"/><stop offset="100%" stop-color="#3b82f6" stop-opacity="0"/></linearGradient></defs>'+gl+'<path d="'+ad+'" fill="url(#'+uid+')"/><path d="'+ld+'" fill="none" stroke="#3b82f6" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>'+pts+'</svg>';
  var tip=document.getElementById('ctip');
  el.querySelectorAll('.cpt').forEach(function(pt){
    pt.addEventListener('mouseenter',function(e){tip.textContent=pt.dataset.d+' : '+pt.dataset.n+' appel'+(pt.dataset.n!=='1'?'s':'');tip.style.display='block';tip.style.left=(e.clientX-40)+'px';tip.style.top=(e.clientY-38)+'px';});
    pt.addEventListener('mousemove',function(e){tip.style.left=(e.clientX-40)+'px';tip.style.top=(e.clientY-38)+'px';});
    pt.addEventListener('mouseleave',function(){tip.style.display='none';});
  });
}

// â”€â”€â”€ CALLS TABLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildCallsTable(id){
  var el=document.getElementById(id);
  if(!el)return;
  var h='<div class="sec-title-lg">Derniers appels <span style="font-size:13px;font-weight:400;color:#94a3b8">('+CALLS.length+')</span></div>';
  h+='<div style="overflow-x:auto"><table><thead><tr>';
  h+='<th>Contact</th><th>NumÃ©ro</th><th>RÃ©sumÃ©</th><th>ProblÃ¨me</th><th>RDV</th><th>ReÃ§u le</th><th>Chat ID</th><th></th>';
  h+='</tr></thead><tbody>';
  CALLS.forEach(function(c){
    var hasRdv=!!c.heure_rdv;
    var statusBadge=hasRdv?'<span class="status-rdv">RDV fixÃ©</span>':'<span class="status-info">Info</span>';
    h+='<tr class="row-link" data-id="'+c.id+'">';
    h+='<td style="font-weight:600;color:#1e293b;white-space:nowrap">'+esc(c.prenom)+'</td>';
    h+='<td style="white-space:nowrap;color:#475569">'+esc(c.numero)+'</td>';
    h+='<td><span class="badge">'+esc(c.resume)+'</span></td>';
    h+='<td style="min-width:180px"><input class="prob-input" data-id="'+c.id+'" value="'+esc(c.probleme)+'" title="'+esc(c.probleme)+'"></td>';
    h+='<td style="white-space:nowrap;'+(hasRdv?'color:#1d4ed8;font-weight:600':'color:#94a3b8')+'">'+fmtDT(c.heure_rdv)+'</td>';
    h+='<td style="white-space:nowrap;color:#64748b;font-size:12px">'+fmtTS(c.timestamp)+'</td>';
    h+='<td style="white-space:nowrap"><code style="font-size:11px;background:#f1f5f9;padding:2px 6px;border-radius:4px;color:#64748b">'+esc(c.chat_id)+'</code></td>';
    h+='<td><button class="del-btn" data-id="'+c.id+'" style="background:none;border:none;color:#94a3b8;cursor:pointer;font-size:16px;padding:2px 4px" title="Supprimer">ğŸ—‘</button></td>';
    h+='</tr>';
  });
  if(CALLS.length===0){h+='<tr><td colspan="8" style="text-align:center;padding:40px;color:#94a3b8">Aucun appel enregistrÃ©</td></tr>';}
  h+='</tbody></table></div>';
  el.innerHTML=h;
  el.querySelectorAll('.prob-input').forEach(function(inp){
    inp.addEventListener('change',function(){
      var id=parseInt(inp.dataset.id);
      var c=CALLS.find(function(x){return x.id===id;});
      if(c)c.probleme=inp.value;
    });
    inp.addEventListener('click',function(e){e.stopPropagation();});
  });
  el.querySelectorAll('.del-btn').forEach(function(btn){
    btn.addEventListener('click',function(e){
      e.stopPropagation();
      if(confirm('Supprimer cet appel ?'))removeCall(parseInt(btn.dataset.id));
    });
  });
  el.querySelectorAll('.row-link').forEach(function(row){
    row.addEventListener('click',function(){openDetail(parseInt(row.dataset.id));});
  });
}

// â”€â”€â”€ CALL DETAIL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openDetail(id){
  var c=CALLS.find(function(x){return x.id===id;});
  if(!c)return;
  document.getElementById('detail-title').textContent=c.prenom;
  var h='';
  h+='<div class="detail-grid">';
  h+='<div class="detail-section detail-gray"><div class="detail-label">PrÃ©nom / Entreprise</div><div class="detail-val">'+esc(c.prenom)+'</div></div>';
  h+='<div class="detail-section detail-gray"><div class="detail-label">NumÃ©ro</div><div class="detail-val"><a href="tel:'+esc(c.numero)+'" style="color:#3b82f6;text-decoration:none">'+esc(c.numero)+'</a></div></div>';
  h+='</div>';
  h+='<div class="detail-section detail-yellow"><div class="detail-label">RÃ©sumÃ©</div><div class="detail-val" style="font-size:15px;font-weight:600">'+esc(c.resume)+'</div></div>';
  h+='<div class="detail-section detail-gray"><div class="detail-label">ProblÃ¨me dÃ©taillÃ©</div><div class="detail-val" style="line-height:1.6">'+esc(c.probleme)+'</div></div>';
  if(c.heure_rdv){
    h+='<div class="detail-section detail-blue"><div class="detail-label">ğŸ“… Rendez-vous fixÃ©</div><div class="detail-val" style="color:#1d4ed8;font-size:15px">'+fmtFull(c.heure_rdv)+'</div></div>';
  }else{
    h+='<div class="detail-section detail-gray"><div class="detail-label">Rendez-vous</div><div class="detail-val" style="color:#94a3b8">Pas encore fixÃ©</div></div>';
  }
  h+='<div class="detail-grid" style="margin-top:12px">';
  h+='<div class="detail-section detail-green" style="margin-bottom:0"><div class="detail-label">â° ReÃ§u le</div><div class="detail-val" style="font-size:13px">'+esc(fmtFull(c.timestamp)||'')+'</div></div>';
  h+='<div class="detail-section detail-gray" style="margin-bottom:0"><div class="detail-label">ğŸ”— Chat ID (n8n)</div><div class="detail-val"><code style="font-size:13px;background:#e2e8f0;padding:3px 8px;border-radius:6px">'+esc(c.chat_id)+'</code></div></div>';
  h+='</div>';
  document.getElementById('detail-body').innerHTML=h;
  document.getElementById('detail-overlay').classList.add('open');
}

// â”€â”€â”€ CALENDAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildCalendar(){
  var el=document.getElementById('cal-widget');
  if(!el)return;
  var fd=new Date(calY,calM,1).getDay();fd=fd===0?6:fd-1;
  var ld=new Date(calY,calM+1,0).getDate();
  var dh=DFR.map(function(d){return '<div class="cal-day-name">'+d+'</div>';}).join('');
  var cells='';
  for(var i=0;i<fd;i++)cells+='<div class="cal-day empty"></div>';
  for(var d=1;d<=ld;d++){
    var it=(calY===2025&&calM===1&&d===18);
    var is=(calSel===d);
    var dot=RDV[dkey(calY,calM,d)]?'<div class="cal-dot"></div>':'';
    var cls='cal-day'+(it?' today':'')+(is&&!it?' selected':'');
    cells+='<div class="'+cls+'" data-d="'+d+'">'+d+dot+'</div>';
  }
  el.innerHTML='<div class="sec-title">Calendrier</div>'+
    '<div class="cal-header">'+
    '<button class="cal-nav" id="cal-prev">&#8249;</button>'+
    '<span style="font-weight:700;font-size:14px;font-family:\'Syne\',sans-serif">'+MFR[calM]+' '+calY+'</span>'+
    '<button class="cal-nav" id="cal-next">&#8250;</button>'+
    '</div>'+
    '<div class="cal-grid" style="margin-bottom:4px">'+dh+'</div>'+
    '<div class="cal-grid" id="cal-days">'+cells+'</div>'+
    '<div class="cal-hint">Cliquez sur un jour pour voir les RDV</div>';
  document.getElementById('cal-prev').onclick=function(){calM--;if(calM<0){calM=11;calY--;}buildCalendar();};
  document.getElementById('cal-next').onclick=function(){calM++;if(calM>11){calM=0;calY++;}buildCalendar();};
  document.getElementById('cal-days').querySelectorAll('.cal-day:not(.empty)').forEach(function(el){
    el.onclick=function(){calSel=parseInt(el.dataset.d);buildCalendar();openAgenda(new Date(calY,calM,calSel));};
  });
}

// â”€â”€â”€ AGENDA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openAgenda(date){
  var key=date.toISOString().split('T')[0];
  var rdvs=RDV[key]||[];
  document.getElementById('agenda-title').textContent=date.toLocaleDateString('fr-FR',{weekday:'long',day:'numeric',month:'long'});
  var hours=[8,9,10,11,12,13,14,15,16,17,18];
  var html='';
  if(rdvs.length===0){
    html='<div style="text-align:center;padding:48px 20px;color:#94a3b8"><div style="font-size:36px;margin-bottom:8px">ğŸ“…</div>Aucun rendez-vous ce jour</div>';
  }else{
    hours.forEach(function(hr){
      var rdv=null;
      for(var i=0;i<rdvs.length;i++){if(parseInt(rdvs[i].t)===hr){rdv=rdvs[i];break;}}
      html+='<div class="agenda-row"><div class="agenda-time">'+hr+':00</div><div class="agenda-slot">'+
        (rdv?'<div class="agenda-event"><div style="font-weight:600;font-size:13px;color:#1e40af">'+esc(rdv.t)+' â€” '+esc(rdv.cl)+'</div><div style="font-size:12px;color:#475569;margin-top:2px">'+esc(rdv.det)+'</div><div style="font-size:11px;color:#94a3b8;margin-top:2px">â± '+rdv.dur+' min</div></div>':'')+
        '</div></div>';
    });
  }
  document.getElementById('agenda-body').innerHTML=html;
  document.getElementById('agenda-overlay').classList.add('open');
}

// â”€â”€â”€ STATS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildStats(){
  var withRdv=CALLS.filter(function(c){return !!c.heure_rdv;}).length;
  var taux=CALLS.length?Math.round(withRdv/CALLS.length*100):0;
  var sc=document.getElementById('stats-cards');
  if(sc)sc.innerHTML=[
    {lb:'Appels enregistrÃ©s',val:String(CALLS.length),col:'#3b82f6',ic:'ğŸ“'},
    {lb:'RDV confirmÃ©s',val:String(withRdv),col:'#22c55e',ic:'âœ…'},
    {lb:'Taux conversion',val:taux+'%',col:'#f59e0b',ic:'ğŸ“ˆ'}
  ].map(function(s){return '<div class="stat-card"><div style="font-size:24px">'+s.ic+'</div><div style="font-weight:700;font-size:22px;color:'+s.col+';margin-top:6px">'+s.val+'</div><div style="font-size:12px;color:#94a3b8;margin-top:2px">'+s.lb+'</div></div>';}).join('');

  var probMap={};
  CALLS.forEach(function(c){
    var kw=['moteur','frein','vidange','pneu','clim','Ã©lectro','boÃ®te','batterie','carrosserie'];
    var found=false;
    kw.forEach(function(k){
      if(!found&&c.probleme&&c.probleme.toLowerCase().indexOf(k)>=0){
        probMap[k]=(probMap[k]||0)+1;found=true;
      }
    });
    if(!found)probMap['autre']=(probMap['autre']||0)+1;
  });
  var probs=Object.keys(probMap).map(function(k){return {lb:k.charAt(0).toUpperCase()+k.slice(1),n:probMap[k]};});
  probs.sort(function(a,b){return b.n-a.n;});
  var maxC=probs.length?probs[0].n:1;
  var pc=document.getElementById('probs-card');
  if(pc){
    pc.innerHTML='<div class="sec-title">ProblÃ¨mes dÃ©tectÃ©s</div>'+(probs.length?probs.map(function(p){
      return '<div style="display:flex;justify-content:space-between;font-size:13px"><span style="color:#334155">'+esc(p.lb)+'</span><span style="font-weight:600;color:#3b82f6">'+p.n+'</span></div>'+
             '<div class="prob-bar-bg"><div class="prob-bar" style="width:'+Math.round(p.n/maxC*100)+'%"></div></div>';
    }).join(''):'<div style="color:#94a3b8;font-size:13px">Aucune donnÃ©e</div>');
  }
  var cc=document.getElementById('stats-chart-card');
  if(cc){cc.innerHTML='<div class="sec-title">ActivitÃ© 7 derniers jours</div><div id="stats-chart"></div>';buildChart('stats-chart',chartData());}
}

function updateAiCount(){
  var el=document.getElementById('ai-count');
  if(el)el.textContent=CALLS.length+' ce mois';
}

// â”€â”€â”€ CLIENTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildClients(){
  var el=document.getElementById('clients-grid');
  if(!el)return;
  if(CALLS.length===0){el.innerHTML='<div style="grid-column:1/-1;text-align:center;padding:60px;color:#94a3b8">Aucun contact</div>';return;}
  el.innerHTML=CALLS.map(function(c){
    return '<div class="client-card" onclick="openDetail('+c.id+')" >' +
      '<div style="width:44px;height:44px;background:#eff6ff;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:20px;margin-bottom:12px">ğŸ¢</div>'+
      '<div style="font-weight:700;font-size:15px;color:#1e293b;margin-bottom:4px">'+esc(c.prenom)+'</div>'+
      '<div style="font-size:13px;color:#64748b;margin-bottom:8px">'+esc(c.numero)+'</div>'+
      '<div style="font-size:12px;color:#475569;background:#f8fafc;border-radius:8px;padding:6px 10px;margin-bottom:6px">'+esc(c.resume)+'</div>'+
      (c.heure_rdv?'<div style="font-size:12px;color:#1d4ed8;font-weight:600">ğŸ“… '+esc(fmtDT(c.heure_rdv))+'</div>':'')+
      '<div style="font-size:11px;color:#94a3b8;margin-top:6px">'+esc(c.timestamp?fmtTS(c.timestamp):'')+'</div>'+
      '</div>';
  }).join('');
}

// â”€â”€â”€ NEW CALL FORM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openNewCall(){
  document.getElementById('f-prenom').value='';
  document.getElementById('f-numero').value='';
  document.getElementById('f-resume').value='';
  document.getElementById('f-probleme').value='';
  document.getElementById('f-rdv').value='';
  document.getElementById('f-chatid').value='';
  document.getElementById('new-err').style.display='none';
  document.getElementById('new-overlay').classList.add('open');
  document.getElementById('f-prenom').focus();
}

function saveNewCall(){
  var prenom=document.getElementById('f-prenom').value.trim();
  var numero=document.getElementById('f-numero').value.trim();
  var resume=document.getElementById('f-resume').value.trim();
  var err=document.getElementById('new-err');
  if(!prenom||!numero||!resume){err.textContent='PrÃ©nom, numÃ©ro et rÃ©sumÃ© sont obligatoires.';err.style.display='block';return;}
  addCall({
    prenom:prenom,
    numero:numero,
    resume:resume,
    probleme:document.getElementById('f-probleme').value.trim(),
    heure_rdv:document.getElementById('f-rdv').value||null,
    timestamp:new Date().toISOString(),
    chat_id:document.getElementById('f-chatid').value.trim()||('manual_'+Date.now())
  });
  document.getElementById('new-overlay').classList.remove('open');
}

// â”€â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.addEventListener('DOMContentLoaded',function(){
  document.getElementById('page-sub').textContent='Mardi 18 fÃ©vrier 2025 Â· Bienvenue sur votre tableau de bord';
  buildNav();
  buildChart('chart-main',chartData());
  buildCallsTable('calls-main');
  buildCallsTable('calls-tab');
  buildCalendar();
  buildStats();
  buildClients();
  updateAiCount();

  document.getElementById('stats-cta').onclick=function(){setTab('stats');};
  document.getElementById('new-btn').onclick=openNewCall;
  document.getElementById('new-save').onclick=saveNewCall;
  document.getElementById('new-close').onclick=function(){document.getElementById('new-overlay').classList.remove('open');};
  document.getElementById('detail-close').onclick=function(){document.getElementById('detail-overlay').classList.remove('open');};
  document.getElementById('agenda-close').onclick=function(){document.getElementById('agenda-overlay').classList.remove('open');};
  ['detail-overlay','agenda-overlay','new-overlay'].forEach(function(id){
    document.getElementById(id).addEventListener('click',function(e){if(e.target===this)this.classList.remove('open');});
  });
});

// â”€â”€â”€ n8n INTEGRATION NOTE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Pour ajouter un appel depuis n8n, utilisez un noeud "Execute Script" ou
// injectez via postMessage / iframe. Exemple de payload attendu :
// {
//   "prenom": "Dupont Jean",
//   "numero": "06 12 34 56 78",
//   "resume": "Bruit moteur",
//   "probleme": "Claquement au dÃ©marrage",
//   "heure_rdv": "2025-02-20T10:00",   <- null si pas de RDV
//   "timestamp": "2025-02-18T08:02:14",
//   "chat_id": "n8n_conv_042"
// }
// Appelez ensuite: window.addCall(payload)
// Pour supprimer: window.removeCall(id)
</script>
</body>
</html>
