<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GarageAI ‚Äî Tableau de bord</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=Syne:wght@700;800&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%;overflow:hidden}
body{font-family:'DM Sans',sans-serif;background:#f1f5f9;color:#1e293b}
::-webkit-scrollbar{width:5px}::-webkit-scrollbar-thumb{background:#cbd5e1;border-radius:99px}
@keyframes pg{0%,100%{box-shadow:0 0 0 0 rgba(34,197,94,.5)}50%{box-shadow:0 0 0 6px rgba(34,197,94,0)}}
@keyframes rg{0%{transform:rotate(0deg)}10%{transform:rotate(-15deg)}20%{transform:rotate(15deg)}30%{transform:rotate(-10deg)}40%{transform:rotate(10deg)}50%,100%{transform:rotate(0deg)}}
@keyframes fu{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
.pdot{width:8px;height:8px;background:#22c55e;border-radius:50%;animation:pg 2s infinite;flex-shrink:0}
.pdot-lg{width:10px;height:10px;background:#22c55e;border-radius:50%;animation:pg 2s infinite;flex-shrink:0}
.ringing{display:inline-block;animation:rg 1s infinite}
.fup{animation:fu .3s ease both}
.layout{display:flex;height:100vh}
.sidebar{width:220px;background:#0f172a;display:flex;flex-direction:column;padding:24px 16px;flex-shrink:0}
.logo-wrap{margin-bottom:32px}
.logo-title{font-family:'Syne',sans-serif;font-weight:800;font-size:20px;color:white}
.logo-dot{color:#3b82f6}.logo-ai{color:#60a5fa}
.logo-sub{color:#475569;font-size:11px;margin-top:2px}
.nav-btn{display:flex;align-items:center;gap:10px;width:100%;padding:10px 12px;border-radius:12px;border:none;background:transparent;color:#94a3b8;font-weight:400;font-size:14px;margin-bottom:4px;text-align:left;transition:all .2s;cursor:pointer;font-family:'DM Sans',sans-serif}
.nav-btn.active{background:#1e40af;color:white;font-weight:600}
.sim-btn{background:linear-gradient(135deg,#2563eb,#7c3aed);color:white;border:none;border-radius:14px;padding:14px 12px;font-weight:700;font-size:13px;width:100%;box-shadow:0 4px 20px rgba(59,130,246,.4);display:flex;align-items:center;justify-content:center;gap:8px;cursor:pointer;font-family:'DM Sans',sans-serif;transition:transform .15s,box-shadow .15s}
.sim-btn:hover{transform:translateY(-2px);box-shadow:0 8px 28px rgba(59,130,246,.55)}
.ai-status{margin-top:14px;display:flex;align-items:center;gap:8px;padding:10px 12px;background:#1e293b;border-radius:12px}
.main{flex:1;overflow:auto;padding:24px;display:flex;flex-direction:column}
.header{display:flex;align-items:center;justify-content:space-between;margin-bottom:24px}
.page-title{font-family:'Syne',sans-serif;font-weight:800;font-size:26px;color:#0f172a;letter-spacing:-.5px}
.page-sub{color:#64748b;font-size:14px;margin-top:2px}
.new-btn{background:#3b82f6;color:white;border:none;border-radius:12px;padding:10px 18px;font-weight:600;font-size:14px;box-shadow:0 4px 14px rgba(59,130,246,.35);cursor:pointer;font-family:'DM Sans',sans-serif}
.card{background:white;border-radius:24px;padding:24px;box-shadow:0 2px 16px rgba(0,0,0,.06)}
.card-sm{background:white;border-radius:20px;padding:20px;box-shadow:0 2px 12px rgba(0,0,0,.06)}
.dash-grid{display:grid;grid-template-columns:1fr 300px;gap:20px}
.left-col{display:flex;flex-direction:column;gap:20px}
.right-col{display:flex;flex-direction:column;gap:16px}
.stats-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:14px;margin-bottom:20px}
.clients-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:16px}
table{border-collapse:collapse;width:100%}
th{text-align:left;padding:8px 10px;font-size:12px;font-weight:600;color:#94a3b8;white-space:nowrap;border-bottom:2px solid #f1f5f9}
td{padding:12px 10px;border-bottom:1px solid #f8fafc;font-size:13px;vertical-align:middle;transition:background .15s}
tr:hover td{background:#f8fafc}
.prob-input{border:1px solid #e2e8f0;border-radius:8px;padding:5px 8px;font-size:12px;color:#334155;width:100%;background:#fafafa;font-family:'DM Sans',sans-serif;transition:border .15s,background .15s}
.prob-input:focus{outline:none;border-color:#3b82f6;background:white}
.badge{display:inline-block;background:#f1f5f9;border-radius:6px;padding:3px 8px;font-size:12px;color:#475569}
.cal-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
.cal-nav{background:#f1f5f9;border:none;border-radius:8px;width:28px;height:28px;color:#475569;font-size:18px;cursor:pointer;line-height:1}
.cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:2px}
.cal-day-name{text-align:center;font-size:11px;font-weight:600;color:#94a3b8;padding:3px 0}
.cal-day{text-align:center;padding:6px 2px;border-radius:8px;cursor:pointer;font-size:13px;border:1.5px solid transparent;transition:all .15s;position:relative}
.cal-day:hover{background:#f1f5f9}
.cal-day.today{background:#3b82f6;color:white;font-weight:700}
.cal-day.selected{background:#eff6ff;border-color:#3b82f6}
.cal-day.empty{cursor:default;pointer-events:none}
.cal-dot{width:4px;height:4px;border-radius:50%;background:#3b82f6;margin:1px auto 0}
.cal-day.today .cal-dot{background:white}
.cal-hint{margin-top:10px;padding:8px 10px;background:#f8fafc;border-radius:10px;font-size:12px;color:#64748b;text-align:center}
.chart-wrap{position:relative;width:100%}
svg.chart{width:100%;height:auto;overflow:visible}
.chart-tip{position:fixed;background:#0f172a;color:white;padding:5px 10px;border-radius:8px;font-size:12px;pointer-events:none;white-space:nowrap;z-index:9999;display:none}
.overlay{position:fixed;inset:0;background:rgba(15,23,42,.65);z-index:200;display:none;align-items:center;justify-content:center;backdrop-filter:blur(4px)}
.overlay.open{display:flex}
.modal{background:white;border-radius:20px;width:480px;max-height:82vh;overflow:hidden;box-shadow:0 25px 60px rgba(0,0,0,.35);animation:fu .3s ease}
.modal-hdr{background:#1e293b;padding:16px 20px;display:flex;align-items:center;justify-content:space-between}
.modal-close{background:#334155;border:none;color:white;border-radius:8px;width:30px;height:30px;font-size:20px;cursor:pointer;line-height:1;display:flex;align-items:center;justify-content:center}
.modal-body{overflow-y:auto;max-height:66vh;padding:8px 16px 20px}
.agenda-row{display:flex;min-height:50px;border-bottom:1px solid #f1f5f9}
.agenda-time{width:46px;padding-top:10px;color:#94a3b8;font-size:11px;flex-shrink:0}
.agenda-slot{flex:1;padding:4px 0 4px 8px}
.agenda-event{background:#eff6ff;border-left:4px solid #3b82f6;border-radius:10px;padding:8px 12px}
.call-modal-wrap{background:white;border-radius:24px;width:400px;box-shadow:0 30px 80px rgba(0,0,0,.4);overflow:hidden;animation:fu .3s ease}
.call-hdr{padding:28px 24px;text-align:center;transition:background .6s}
.hdr-ring{background:linear-gradient(135deg,#1e40af,#3b82f6)}
.hdr-active{background:linear-gradient(135deg,#166534,#16a34a)}
.call-body{padding:20px 24px}
.info-box{border-radius:12px;padding:12px 14px;margin-bottom:12px}
.info-yellow{background:#fef3c7;border-left:4px solid #f59e0b}
.info-gray{background:#f8fafc}
.info-blue{background:#eff6ff;border-left:4px solid #3b82f6;margin-bottom:16px}
.info-green{background:#f0fdf4;margin-bottom:16px}
.call-footer{padding:20px 24px;text-align:center}
.btn-row{display:flex;gap:12px}
.btn-ignore{flex:1;background:#fef2f2;color:#ef4444;border:none;border-radius:12px;padding:12px;font-weight:600;cursor:pointer;font-family:'DM Sans',sans-serif}
.btn-answer{flex:1;background:#22c55e;color:white;border:none;border-radius:12px;padding:12px;font-weight:600;cursor:pointer;font-family:'DM Sans',sans-serif}
.btn-end{width:100%;background:#1e293b;color:white;border:none;border-radius:12px;padding:12px;font-weight:600;font-size:14px;cursor:pointer;font-family:'DM Sans',sans-serif}
.stat-card{background:white;border-radius:16px;padding:16px;box-shadow:0 2px 12px rgba(0,0,0,.06)}
.stat-val{font-weight:700;font-size:22px;margin-top:6px}
.stat-lbl{font-size:12px;color:#94a3b8;margin-top:2px}
.prob-bar-bg{background:#f1f5f9;border-radius:99px;height:6px;margin-top:4px;margin-bottom:10px}
.prob-bar{background:#3b82f6;border-radius:99px;height:6px}
.prob-row{display:flex;justify-content:space-between;font-size:13px}
.client-card{background:white;border-radius:20px;padding:20px;box-shadow:0 2px 12px rgba(0,0,0,.06)}
.client-icon{width:44px;height:44px;background:#eff6ff;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:20px;margin-bottom:12px}
.tab-content{display:none}.tab-content.active{display:block}
.sec-title{font-family:'Syne',sans-serif;font-weight:700;font-size:15px;color:#1e293b;margin-bottom:14px}
.sec-title-lg{font-family:'Syne',sans-serif;font-weight:700;font-size:16px;color:#1e293b;margin-bottom:16px}
.ai-row{display:flex;justify-content:space-between;font-size:13px;margin-bottom:6px}
.stats-cta{background:linear-gradient(135deg,#0f172a,#1e293b);color:white;border:none;border-radius:20px;padding:16px;cursor:pointer;text-align:left;box-shadow:0 4px 16px rgba(0,0,0,.15);width:100%;font-family:'DM Sans',sans-serif}
.chart-hdr{display:flex;align-items:center;justify-content:space-between;margin-bottom:20px}
.pill{background:#eff6ff;color:#3b82f6;font-size:12px;padding:4px 10px;border-radius:99px;font-weight:600}
</style>
</head>
<body>
<div class="layout">
  <aside class="sidebar">
    <div class="logo-wrap">
      <div class="logo-title">Garage<span class="logo-dot">.</span><span class="logo-ai">AI</span></div>
      <div class="logo-sub">Gestionnaire Automobile</div>
    </div>
    <nav style="flex:1" id="nav"></nav>
    <button class="sim-btn" id="sim-btn">üì≤ Simuler Appel</button>
    <div class="ai-status">
      <div class="pdot"></div>
      <div>
        <div style="color:white;font-size:12px;font-weight:600">IA en ligne</div>
        <div style="color:#475569;font-size:10px">n8n ¬∑ actif</div>
      </div>
    </div>
  </aside>

  <main class="main">
    <div class="header">
      <div>
        <h1 class="page-title" id="page-title">Tableau de bord</h1>
        <p class="page-sub" id="page-sub"></p>
      </div>
      <button class="new-btn">+ Nouvel Appel</button>
    </div>

    <div id="tab-dashboard" class="tab-content active">
      <div class="dash-grid">
        <div class="left-col">
          <div class="card">
            <div class="chart-hdr">
              <div>
                <div class="sec-title-lg" style="margin-bottom:2px">Activit√© des appels</div>
                <div style="color:#94a3b8;font-size:13px">7 derniers jours ¬∑ 84 appels ce mois</div>
              </div>
              <span class="pill">üìà Semaine en cours</span>
            </div>
            <div class="chart-wrap" id="chart-main"></div>
          </div>
          <div class="card" id="calls-main"></div>
        </div>
        <div class="right-col">
          <div class="card-sm" id="cal-widget"></div>
          <div class="card-sm">
            <div style="display:flex;align-items:center;gap:8px;margin-bottom:14px">
              <div class="pdot-lg"></div>
              <span class="sec-title" style="margin:0">IA en ligne</span>
            </div>
            <div class="ai-row"><span style="color:#94a3b8">Mod√®le</span><span style="font-weight:500">GPT-4o via n8n</span></div>
            <div class="ai-row"><span style="color:#94a3b8">Webhook</span><span style="font-weight:500">Connect√© ‚úì</span></div>
            <div class="ai-row"><span style="color:#94a3b8">R√©ponse moy.</span><span style="font-weight:500">1.4s</span></div>
            <div class="ai-row"><span style="color:#94a3b8">Appels trait√©s</span><span style="font-weight:500">84 ce mois</span></div>
          </div>
          <button class="stats-cta" id="stats-cta">
            <div style="font-size:24px;margin-bottom:6px">üìä</div>
            <div style="font-weight:700;font-family:'Syne',sans-serif;font-size:14px;margin-bottom:4px">Voir les statistiques</div>
            <div style="font-size:12px;color:#94a3b8">Conversion, top probl√®mes, tendances</div>
          </button>
        </div>
      </div>
    </div>

    <div id="tab-calls" class="tab-content">
      <div class="card fup" id="calls-tab"></div>
    </div>
    <div id="tab-clients" class="tab-content">
      <div class="clients-grid fup" id="clients-grid"></div>
    </div>
    <div id="tab-stats" class="tab-content fup">
      <div class="stats-grid" id="stats-cards"></div>
      <div class="card-sm" style="margin-bottom:16px" id="probs-card"></div>
      <div class="card-sm" id="stats-chart-card"></div>
    </div>
  </main>
</div>

<div class="overlay" id="agenda-overlay">
  <div class="modal" id="agenda-modal">
    <div class="modal-hdr">
      <div>
        <div style="color:#94a3b8;font-size:12px">Agenda du</div>
        <div id="agenda-title" style="color:white;font-weight:700;font-size:16px;font-family:'Syne',sans-serif"></div>
      </div>
      <button class="modal-close" id="agenda-close">√ó</button>
    </div>
    <div class="modal-body" id="agenda-body"></div>
  </div>
</div>

<div class="overlay" id="call-overlay">
  <div class="call-modal-wrap" id="call-inner"></div>
</div>

<div class="chart-tip" id="ctip"></div>

<script>
var CHART=[{day:'Lun 12',n:8},{day:'Mar 13',n:14},{day:'Mer 14',n:11},{day:'Jeu 15',n:17},{day:'Ven 16',n:22},{day:'Sam 17',n:9},{day:'Dim 18',n:3}];
var CALLS=[
  {id:1,co:'Transports Dupont',res:'Bruit moteur anormal',prob:'Claquement d√©marrage √† froid, possible distribution',rdv:'2025-02-18T09:30',tel:'06 12 34 56 78'},
  {id:2,co:'BTP Marchand SARL',res:'Voyant moteur allum√©',prob:'T√©moin orange 3 jours, perte de puissance ressentie',rdv:'2025-02-18T11:00',tel:'07 89 01 23 45'},
  {id:3,co:'Livraisons Express 31',res:'Pneu crev√© sur A64',prob:'Crevaison arri√®re droit, pneu de secours pos√©',rdv:null,tel:'06 55 44 33 22'},
  {id:4,co:'Cabinet Notarial L√©on',res:'Vidange + r√©vision',prob:'V√©hicule √† 45 000 km, r√©vision compl√®te demand√©e',rdv:'2025-02-19T14:00',tel:'05 61 78 90 12'},
  {id:5,co:'Agence Immobili√®re Sud',res:'Freins qui crissent',prob:'Bruit m√©tallique au freinage, plaquettes √† v√©rifier',rdv:'2025-02-20T10:00',tel:'06 33 22 11 00'},
  {id:6,co:'Menuiserie Fabre',res:'Climatisation en panne',prob:'Clim ne refroidit plus depuis la semaine derni√®re',rdv:null,tel:'06 77 66 55 44'}
];
var RDV={
  '2025-02-18':[{t:'09:30',dur:60,cl:'Transports Dupont',det:'Bruit moteur ‚Äì Diagnostic'},{t:'11:00',dur:90,cl:'BTP Marchand SARL',det:'Voyant moteur ‚Äì Contr√¥le OBD'},{t:'14:30',dur:45,cl:'Auto √âcole Martin',det:'Contr√¥le technique pr√©ventif'},{t:'16:00',dur:30,cl:'SARL Constructions Nord',det:'Devis carrosserie'}],
  '2025-02-19':[{t:'08:30',dur:120,cl:'Cabinet Notarial L√©on',det:'Vidange + r√©vision 45k km'},{t:'11:00',dur:60,cl:'Flotte Renault SAS',det:'Remplacement courroie'},{t:'15:00',dur:45,cl:'Pharmacie Centrale',det:'Diagnostic √©lectronique'}],
  '2025-02-20':[{t:'10:00',dur:60,cl:'Agence Immobili√®re Sud',det:'Freins ‚Äì Remplacement plaquettes'},{t:'13:30',dur:90,cl:'Soci√©t√© G√©nie Civil 31',det:'Bo√Æte de vitesses ‚Äì Inspection'}],
  '2025-02-21':[{t:'09:00',dur:45,cl:'Restaurant Le Quercy',det:'Batterie d√©charg√©e ‚Äì Remplacement'},{t:'14:00',dur:120,cl:'Taxi Occitanie',det:'R√©vision compl√®te + contr√¥le'},{t:'16:30',dur:30,cl:'Boulangerie Moreau',det:'Pneus ‚Äì Permutation saisonni√®re'}],
  '2025-02-24':[{t:'10:30',dur:60,cl:'Studio Photo Lumi√®re',det:'Climatisation ‚Äì Recharge gaz'},{t:'15:00',dur:45,cl:'Mairie de Blagnac',det:'Contr√¥le p√©riodique flotte'}]
};
var SIMS=[
  {co:'Transports Leclerc & Fils',tel:'06 42 18 73 05',sit:'Claquement m√©tallique sous capot au d√©marrage',det:'R√©p√©t√© √† froid, dispara√Æt apr√®s 2 min. KM: 87 400. Renault Master 2019.',rdv:'2025-02-19T08:30'},
  {co:'SARL √âlectricit√© Faure',tel:'07 63 29 41 87',sit:"Fum√©e blanche √† l'√©chappement",det:"Continue depuis matin, conso eau anormale. Suspicion joint de culasse. Peugeot Partner 2020.",rdv:null},
  {co:'Flotte VTC Toulouse',tel:'06 81 54 32 09',sit:'Vibrations au freinage haute vitesse',det:'Volant vibre lors freinages >100km/h. Disques avant probablement voil√©s. Toyota Camry 2022.',rdv:'2025-02-20T14:30'},
  {co:'Cabinet M√©dical Pyr√©n√©es',tel:'05 61 22 87 44',sit:'Voyant huile + t√©moin moteur allum√©s',det:'Deux t√©moins apr√®s long trajet. Niveau huile OK mais pression faible. BMW 320d 2021.',rdv:null},
  {co:'Agence Compta Gestion Sud',tel:'06 17 93 62 58',sit:"Bo√Æte auto qui patine 2√®me-3√®me",det:"Passage h√©sitant, odeur br√ªl√© lors acc√©l√©rations. VW Passat 2018 ‚Äì 110 000 km.",rdv:'2025-02-21T09:00'}
];
var PROBS=[{lb:'Moteur / Diagnostic',n:24},{lb:'Freins',n:18},{lb:'Vidange / R√©vision',n:15},{lb:'Pneumatiques',n:12},{lb:'Climatisation',n:8},{lb:'√âlectronique',n:7}];
var MFR=['Janvier','F√©vrier','Mars','Avril','Mai','Juin','Juillet','Ao√ªt','Septembre','Octobre','Novembre','D√©cembre'];
var DFR=['Lun','Mar','Mer','Jeu','Ven','Sam','Dim'];
var NAV=[{id:'dashboard',lb:'Tableau de bord',ic:'‚äû'},{id:'calls',lb:'Appels',ic:'üìû'},{id:'clients',lb:'Clients',ic:'üë•'},{id:'stats',lb:'Statistiques',ic:'üìä'}];

var calY=2025,calM=1,calSel=null,callTimer=null,callStep='ringing',callData=null;
var probs={};
CALLS.forEach(function(c){probs[c.id]=c.prob;});

function esc(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}
function fmtL(dt){if(!dt)return null;var d=new Date(dt);return d.toLocaleDateString('fr-FR',{weekday:'long',day:'numeric',month:'long'})+' √† '+d.toLocaleTimeString('fr-FR',{hour:'2-digit',minute:'2-digit'});}
function fmtS(dt){if(!dt)return '‚Äî';var d=new Date(dt);return d.toLocaleDateString('fr-FR',{day:'2-digit',month:'2-digit'})+' '+d.toLocaleTimeString('fr-FR',{hour:'2-digit',minute:'2-digit'});}
function dkey(y,m,d){return y+'-'+String(m+1).padStart(2,'0')+'-'+String(d).padStart(2,'0');}

function setTab(id){
  document.querySelectorAll('.tab-content').forEach(function(el){el.classList.remove('active');});
  document.getElementById('tab-'+id).classList.add('active');
  document.querySelectorAll('.nav-btn').forEach(function(b){b.classList.toggle('active',b.dataset.id===id);});
  var labs={dashboard:'Tableau de bord',calls:'Appels',clients:'Clients',stats:'Statistiques'};
  document.getElementById('page-title').textContent=labs[id];
}

function buildNav(){
  var nav=document.getElementById('nav');
  NAV.forEach(function(item){
    var b=document.createElement('button');
    b.className='nav-btn'+(item.id==='dashboard'?' active':'');
    b.dataset.id=item.id;
    b.innerHTML='<span style="font-size:16px">'+item.ic+'</span>'+esc(item.lb);
    b.onclick=function(){setTab(item.id);};
    nav.appendChild(b);
  });
}

function buildChart(id,data){
  var el=document.getElementById(id);
  if(!el)return;
  var W=500,H=150,PX=36,PY=18,maxV=0;
  for(var i=0;i<data.length;i++){if(data[i].n>maxV)maxV=data[i].n;}
  function px(i){return PX+(i/(data.length-1))*(W-PX*2);}
  function py(v){return PY+(1-v/(maxV||1))*(H-PY*2);}
  var ld=data.map(function(d,i){return (i===0?'M':'L')+px(i).toFixed(1)+','+py(d.n).toFixed(1);}).join(' ');
  var ad=ld+' L'+px(data.length-1).toFixed(1)+','+(H-PY)+' L'+px(0).toFixed(1)+','+(H-PY)+' Z';
  var uid='g'+Math.random().toString(36).slice(2,7);
  var gl=[0,0.33,0.66,1].map(function(t,i){
    var y=PY+t*(H-PY*2);
    return '<line x1="'+PX+'" y1="'+y.toFixed(1)+'" x2="'+(W-PX)+'" y2="'+y.toFixed(1)+'" stroke="#e2e8f0" stroke-width="1" stroke-dasharray="4,3"/><text x="'+(PX-5)+'" y="'+(y+4).toFixed(1)+'" text-anchor="end" font-size="10" fill="#94a3b8">'+Math.round(maxV*(1-t))+'</text>';
  }).join('');
  var pts=data.map(function(d,i){
    return '<circle class="cpt" cx="'+px(i).toFixed(1)+'" cy="'+py(d.n).toFixed(1)+'" r="5" fill="#3b82f6" stroke="white" stroke-width="2" data-d="'+esc(d.day)+'" data-n="'+d.n+'" style="cursor:pointer"/>'+
           '<text x="'+px(i).toFixed(1)+'" y="'+(H-3)+'" text-anchor="middle" font-size="10" fill="#64748b">'+d.day.split(' ')[0]+'</text>';
  }).join('');
  el.innerHTML='<svg class="chart" viewBox="0 0 '+W+' '+H+'"><defs><linearGradient id="'+uid+'" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="#3b82f6" stop-opacity="0.2"/><stop offset="100%" stop-color="#3b82f6" stop-opacity="0"/></linearGradient></defs>'+gl+'<path d="'+ad+'" fill="url(#'+uid+')"/><path d="'+ld+'" fill="none" stroke="#3b82f6" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>'+pts+'</svg>';
  var tip=document.getElementById('ctip');
  el.querySelectorAll('.cpt').forEach(function(pt){
    pt.addEventListener('mouseenter',function(e){tip.textContent=pt.dataset.d+' : '+pt.dataset.n+' appels';tip.style.display='block';tip.style.left=(e.clientX-40)+'px';tip.style.top=(e.clientY-38)+'px';});
    pt.addEventListener('mousemove',function(e){tip.style.left=(e.clientX-40)+'px';tip.style.top=(e.clientY-38)+'px';});
    pt.addEventListener('mouseleave',function(){tip.style.display='none';});
  });
}

function callsTableHTML(){
  var h='<div class="sec-title-lg">Derniers appels</div><div style="overflow-x:auto"><table><thead><tr><th>Entreprise</th><th>R√©sum√©</th><th>Probl√®me (√©ditable)</th><th>Heure RDV</th><th>T√©l√©phone</th></tr></thead><tbody>';
  CALLS.forEach(function(c){
    var rc=c.rdv?'color:#1d4ed8;font-weight:600':'color:#94a3b8';
    h+='<tr><td style="font-weight:600;color:#1e293b;white-space:nowrap">'+esc(c.co)+'</td><td><span class="badge">'+esc(c.res)+'</span></td><td style="min-width:200px"><input class="prob-input" data-id="'+c.id+'" value="'+esc(probs[c.id])+'"></td><td style="white-space:nowrap;'+rc+'">'+fmtS(c.rdv)+'</td><td style="white-space:nowrap;color:#475569">'+esc(c.tel)+'</td></tr>';
  });
  return h+'</tbody></table></div>';
}
function bindInputs(el){
  el.querySelectorAll('.prob-input').forEach(function(inp){
    inp.addEventListener('change',function(){probs[inp.dataset.id]=inp.value;});
  });
}

function buildCalendar(){
  var el=document.getElementById('cal-widget');
  if(!el)return;
  var fd=new Date(calY,calM,1).getDay();fd=fd===0?6:fd-1;
  var ld=new Date(calY,calM+1,0).getDate();
  var dh=DFR.map(function(d){return '<div class="cal-day-name">'+d+'</div>';}).join('');
  var cells='';
  for(var i=0;i<fd;i++)cells+='<div class="cal-day empty"></div>';
  for(var d=1;d<=ld;d++){
    var it=(calY===2025&&calM===1&&d===18);
    var is=(calSel===d);
    var dot=RDV[dkey(calY,calM,d)]?'<div class="cal-dot"></div>':'';
    var cls='cal-day'+(it?' today':'')+(is&&!it?' selected':'');
    cells+='<div class="'+cls+'" data-d="'+d+'">'+d+dot+'</div>';
  }
  el.innerHTML='<div class="sec-title">Calendrier</div>'+
    '<div class="cal-header">'+
    '<button class="cal-nav" id="cal-prev">&#8249;</button>'+
    '<span style="font-weight:700;font-size:14px;font-family:\'Syne\',sans-serif">'+MFR[calM]+' '+calY+'</span>'+
    '<button class="cal-nav" id="cal-next">&#8250;</button>'+
    '</div>'+
    '<div class="cal-grid" style="margin-bottom:4px">'+dh+'</div>'+
    '<div class="cal-grid" id="cal-days">'+cells+'</div>'+
    '<div class="cal-hint">Cliquez sur un jour pour voir les RDV</div>';
  document.getElementById('cal-prev').onclick=function(){calM--;if(calM<0){calM=11;calY--;}buildCalendar();};
  document.getElementById('cal-next').onclick=function(){calM++;if(calM>11){calM=0;calY++;}buildCalendar();};
  document.getElementById('cal-days').querySelectorAll('.cal-day:not(.empty)').forEach(function(el){
    el.onclick=function(){calSel=parseInt(el.dataset.d);buildCalendar();openAgenda(new Date(calY,calM,calSel));};
  });
}

function openAgenda(date){
  var key=date.toISOString().split('T')[0];
  var rdvs=RDV[key]||[];
  document.getElementById('agenda-title').textContent=date.toLocaleDateString('fr-FR',{weekday:'long',day:'numeric',month:'long'});
  var hours=[8,9,10,11,12,13,14,15,16,17,18];
  var html='';
  if(rdvs.length===0){
    html='<div style="text-align:center;padding:48px 20px;color:#94a3b8"><div style="font-size:36px;margin-bottom:8px">üìÖ</div>Aucun rendez-vous ce jour</div>';
  }else{
    hours.forEach(function(hr){
      var rdv=null;
      for(var i=0;i<rdvs.length;i++){if(parseInt(rdvs[i].t)===hr){rdv=rdvs[i];break;}}
      html+='<div class="agenda-row"><div class="agenda-time">'+hr+':00</div><div class="agenda-slot">'+
        (rdv?'<div class="agenda-event"><div style="font-weight:600;font-size:13px;color:#1e40af">'+esc(rdv.t)+' ‚Äî '+esc(rdv.cl)+'</div><div style="font-size:12px;color:#475569;margin-top:2px">'+esc(rdv.det)+'</div><div style="font-size:11px;color:#94a3b8;margin-top:2px">‚è± '+rdv.dur+' min</div></div>':'')+
        '</div></div>';
    });
  }
  document.getElementById('agenda-body').innerHTML=html;
  document.getElementById('agenda-overlay').classList.add('open');
}

function buildStats(){
  var sc=document.getElementById('stats-cards');
  if(sc)sc.innerHTML=[{lb:'Appels ce mois',val:'84',col:'#3b82f6',ic:'üìû'},{lb:'RDV confirm√©s',val:'31',col:'#22c55e',ic:'‚úÖ'},{lb:'Taux conversion',val:'36.9%',col:'#f59e0b',ic:'üìà'}].map(function(s){return '<div class="stat-card"><div style="font-size:24px">'+s.ic+'</div><div class="stat-val" style="color:'+s.col+'">'+s.val+'</div><div class="stat-lbl">'+s.lb+'</div></div>';}).join('');
  var maxC=0;PROBS.forEach(function(p){if(p.n>maxC)maxC=p.n;});
  var pc=document.getElementById('probs-card');
  if(pc)pc.innerHTML='<div class="sec-title">Top probl√®mes signal√©s</div>'+PROBS.map(function(p){return '<div class="prob-row"><span style="color:#334155">'+esc(p.lb)+'</span><span style="font-weight:600;color:#3b82f6">'+p.n+'</span></div><div class="prob-bar-bg"><div class="prob-bar" style="width:'+Math.round(p.n/maxC*100)+'%"></div></div>';}).join('');
  var cc=document.getElementById('stats-chart-card');
  if(cc){cc.innerHTML='<div class="sec-title">Activit√© 7 derniers jours</div><div id="stats-chart"></div>';buildChart('stats-chart',CHART);}
}

function buildClients(){
  var el=document.getElementById('clients-grid');
  if(!el)return;
  el.innerHTML=CALLS.map(function(c){return '<div class="client-card"><div class="client-icon">üè¢</div><div style="font-weight:700;font-size:15px;color:#1e293b;margin-bottom:4px">'+esc(c.co)+'</div><div style="font-size:13px;color:#64748b;margin-bottom:8px">'+esc(c.tel)+'</div><div style="font-size:12px;color:#475569;background:#f8fafc;border-radius:8px;padding:6px 10px;margin-bottom:6px">'+esc(c.res)+'</div>'+(c.rdv?'<div style="font-size:12px;color:#1d4ed8;font-weight:600">üìÖ '+fmtS(c.rdv)+'</div>':'')+'</div>';}).join('');
}

function simulateCall(){
  callData=SIMS[Math.floor(Math.random()*SIMS.length)];
  callStep='ringing';
  renderCall();
  document.getElementById('call-overlay').classList.add('open');
  callTimer=setTimeout(answerCall,2500);
}

function renderCall(){
  var c=callData,step=callStep;
  var hdrCls=step==='ringing'?'hdr-ring':'hdr-active';
  var ico=step==='ringing'?'üì≤':'üîß';
  var icoCls=step==='ringing'?'ringing':'';
  var sub=step==='ringing'?'Appel entrant simul√©':'Appel en cours ‚Äî IA active';
  var body='';
  if(step==='active'){
    var rdvH=c.rdv?'<div class="info-box info-blue"><div style="font-weight:600;font-size:12px;color:#1e40af;margin-bottom:2px">üìÖ Rendez-vous fix√©</div><div style="font-size:14px;color:#1d4ed8;font-weight:600">'+fmtL(c.rdv)+'</div></div>':'<div class="info-box info-green"><div style="font-weight:600;font-size:12px;color:#166534;margin-bottom:2px">üí¨ Statut</div><div style="font-size:13px;color:#166534">Demande d\'information ‚Äì pas de RDV</div></div>';
    body='<div class="call-body"><div class="info-box info-yellow"><div style="font-weight:600;font-size:12px;color:#92400e;margin-bottom:4px">üé§ Situation signal√©e</div><div style="font-size:14px;color:#78350f;font-weight:500">'+esc(c.sit)+'</div></div><div class="info-box info-gray"><div style="font-weight:600;font-size:12px;color:#475569;margin-bottom:4px">üìã Diagnostic IA</div><div style="font-size:13px;color:#334155;line-height:1.6">'+esc(c.det)+'</div></div>'+rdvH+'<button class="btn-end" id="btn-end">Terminer l\'appel</button></div>';
  }else{
    body='<div class="call-footer"><div style="color:#64748b;font-size:14px;margin-bottom:16px">Connexion en cours‚Ä¶</div><div class="btn-row"><button class="btn-ignore" id="btn-ignore">‚úï Ignorer</button><button class="btn-answer" id="btn-answer">üìû D√©crocher</button></div></div>';
  }
  document.getElementById('call-inner').innerHTML='<div class="call-hdr '+hdrCls+'"><div class="'+icoCls+'" style="font-size:40px;margin-bottom:8px">'+ico+'</div><div style="color:rgba(255,255,255,.75);font-size:12px;margin-bottom:4px">'+sub+'</div><div style="color:white;font-weight:700;font-size:20px;font-family:\'Syne\',sans-serif">'+esc(c.co)+'</div><div style="color:rgba(255,255,255,.85);font-size:14px;margin-top:4px">'+esc(c.tel)+'</div></div>'+body;
  var be=document.getElementById('btn-end');
  var bi=document.getElementById('btn-ignore');
  var ba=document.getElementById('btn-answer');
  if(be)be.onclick=closeCall;
  if(bi)bi.onclick=closeCall;
  if(ba)ba.onclick=answerCall;
}

function answerCall(){clearTimeout(callTimer);callStep='active';renderCall();}
function closeCall(){clearTimeout(callTimer);document.getElementById('call-overlay').classList.remove('open');}

document.addEventListener('DOMContentLoaded',function(){
  document.getElementById('page-sub').textContent='Mardi 18 f√©vrier 2025 ¬∑ Bienvenue sur votre tableau de bord';
  buildNav();
  buildChart('chart-main',CHART);
  var cm=document.getElementById('calls-main');if(cm){cm.innerHTML=callsTableHTML();bindInputs(cm);}
  var ct=document.getElementById('calls-tab');if(ct){ct.innerHTML=callsTableHTML();bindInputs(ct);}
  buildCalendar();
  buildStats();
  buildClients();
  document.getElementById('sim-btn').onclick=simulateCall;
  document.getElementById('stats-cta').onclick=function(){setTab('stats');};
  document.getElementById('agenda-close').onclick=function(){document.getElementById('agenda-overlay').classList.remove('open');};
  document.getElementById('agenda-overlay').addEventListener('click',function(e){if(e.target===this)this.classList.remove('open');});
  document.getElementById('call-overlay').addEventListener('click',function(e){if(e.target===this)closeCall();});
});
</script>
</body>
</html>
